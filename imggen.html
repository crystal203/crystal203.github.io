<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI å›¾åƒç”Ÿæˆå™¨</title>
  <style>
    :root {
      --bg: #f8f9fa;
      --card: #ffffff;
      --border: #e0e0e0;
      --text: #333;
      --primary: #4361ee;
      --primary-hover: #3a56d4;
      --danger: #e63946;
      --success: #4cc9f0;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212;
        --card: #1e1e1e;
        --border: #333;
        --text: #e0e0e0;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 2.2rem;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #6c757d;
      font-size: 1.1rem;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 24px;
      margin-bottom: 24px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .form-grid { grid-template-columns: 1fr; }
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 0.95rem;
    }

    input, select, textarea {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: transparent;
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: border 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: var(--primary-hover);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      background: rgba(67, 97, 238, 0.08);
    }

    .status {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.9rem;
    }

    .status.info { background: #e3f2fd; color: #1565c0; }
    .status.success { background: #e8f5e9; color: #2e7d32; }
    .status.error { background: #ffebee; color: #c62828; }

    .image-container {
      position: relative;
      width: 100%;
      height: 600px;
      background: #f5f5f5;
      border-radius: 12px;
      overflow: hidden;
      cursor: grab;
      margin-top: 24px;
    }

    .image-container.dragging {
      cursor: grabbing;
    }

    .image-placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #999;
    }

    .image-placeholder svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    #imageView {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0;
      transition: transform 0.1s ease;
      user-select: none;
    }

    .zoom-info {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.85rem;
      pointer-events: none;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      color: #6c757d;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>AI å›¾åƒç”Ÿæˆå™¨</h1>
      <p class="subtitle">ä» https://ai.gitee.com/ è·å– apikey</p>
    </header>

    <main>
      <div class="card">
        <div class="form-grid">
          <div class="form-group">
            <label for="apiKey">API Key</label>
            <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ API Key" autocomplete="off" />
          </div>
          <div class="form-group">
            <label for="size">å›¾åƒå°ºå¯¸</label>
            <select id="size">
              <option value="1024x1024">1024Ã—1024ï¼ˆæ­£æ–¹å½¢ï¼‰</option>
              <option value="768x1024">768Ã—1024ï¼ˆç«–å±ï¼‰</option>
              <option value="1024x768">1024Ã—768ï¼ˆæ¨ªå±ï¼‰</option>
              <option value="512x512">512Ã—512ï¼ˆå°å›¾ï¼‰</option>
              <option value="2048x2048">2048Ã—2048ï¼ˆé«˜æ¸…æ­£æ–¹ï¼‰</option>
              <option value="1536x2048">1536Ã—2048ï¼ˆé«˜æ¸…ç«–å±ï¼‰</option>
              <option value="2048x1536">2048Ã—1536ï¼ˆé«˜æ¸…æ¨ªå±ï¼‰</option>
              <option value="2048x1152">2048Ã—1152ï¼ˆå®½å±ï¼‰</option>
              <option value="1152x2048">1152Ã—2048ï¼ˆè¶…å®½ç«–å±ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="form-group" style="margin-top: 16px;">
          <label for="prompt">Prompt</label>
          <textarea id="prompt" rows="3" placeholder="è¾“å…¥ä½ çš„å›¾åƒæè¿°"></textarea>
        </div>

        <div class="btn-group">
          <button id="generateBtn">ğŸ¨ ç”Ÿæˆå›¾åƒ</button>
          <button id="downloadBtn" class="btn-outline" disabled>ğŸ“¥ ä¸‹è½½ ZIP</button>
          <button id="resetBtn" class="btn-outline">â†º é‡ç½®</button>
        </div>

        <div id="status" class="status info" style="display: none;"></div>
      </div>

      <div class="card">
        <h2>ç”Ÿæˆç»“æœ</h2>
        <div class="image-container" id="imageContainer">
          <div class="image-placeholder" id="placeholder">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <p>ç‚¹å‡»ã€Œç”Ÿæˆå›¾åƒã€å¼€å§‹åˆ›ä½œ</p>
          </div>
          <img id="imageView" style="display: none;" draggable="false" />
          <div class="zoom-info" id="zoomInfo" style="display: none;">ç¼©æ”¾: 100%</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ========== çŠ¶æ€ç®¡ç† ==========
    const state = {
      apiKey: localStorage.getItem('apiKey') || '',
      prompt: '',
      size: '1024x1024',
      imageBlob: null,
      imageUrl: null,
      zoom: 1,
      panX: 0,
      panY: 0,
      isDragging: false,
      dragStart: { x: 0, y: 0 },
      images: [] // å­˜å‚¨ç”Ÿæˆçš„ image blobs
    };

    // DOM å…ƒç´ 
    const el = {
      apiKey: document.getElementById('apiKey'),
      prompt: document.getElementById('prompt'),
      size: document.getElementById('size'),
      generateBtn: document.getElementById('generateBtn'),
      downloadBtn: document.getElementById('downloadBtn'),
      resetBtn: document.getElementById('resetBtn'),
      status: document.getElementById('status'),
      imageContainer: document.getElementById('imageContainer'),
      imageView: document.getElementById('imageView'),
      placeholder: document.getElementById('placeholder'),
      zoomInfo: document.getElementById('zoomInfo')
    };

    // åˆå§‹åŒ–
    el.apiKey.value = state.apiKey;
    el.size.value = state.size;

    // ========== å·¥å…·å‡½æ•° ==========
    function showStatus(message, type = 'info') {
      el.status.textContent = message;
      el.status.className = `status ${type}`;
      el.status.style.display = 'block';
    }

    function hideStatus() {
      el.status.style.display = 'none';
    }

    function updateZoomDisplay() {
      const percent = Math.round(state.zoom * 100);
      el.zoomInfo.textContent = `ç¼©æ”¾: ${percent}%`;
      el.zoomInfo.style.display = 'block';
    }

    // ========== å›¾åƒæ“ä½œ ==========
    function setImage(blob) {
      if (state.imageUrl) URL.revokeObjectURL(state.imageUrl);
      state.imageUrl = URL.createObjectURL(blob);
      state.imageBlob = blob;

      const img = el.imageView;
      img.src = state.imageUrl;
      img.style.display = 'block';
      el.placeholder.style.display = 'none';

      // é‡ç½®è§†å›¾
      state.zoom = 1;
      state.panX = 0;
      state.panY = 0;
      applyTransform();
      updateZoomDisplay();
    }

    function applyTransform() {
      const { zoom, panX, panY } = state;
      el.imageView.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
    }

    // ========== ç”Ÿæˆå›¾åƒ ==========
    async function generateImage() {
      const apiKey = el.apiKey.value.trim();
      const prompt = el.prompt.value.trim();
      const size = el.size.value;

      if (!apiKey) return showStatus('âš ï¸ è¯·è¾“å…¥ API Key', 'error');
      if (!prompt) return showStatus('âš ï¸ è¯·è¾“å…¥ Prompt', 'error');

      showStatus('ğŸš€ æ­£åœ¨è°ƒç”¨ API ç”Ÿæˆå›¾åƒ...', 'info');
      el.generateBtn.disabled = true;

      try {
        const response = await fetch('https://ai.gitee.com/v1/images/generations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            prompt: prompt,
            model: 'z-image-turbo',
            size: size,
            num_inference_steps: 9
          })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(`HTTP ${response.status}: ${err.error?.message || response.statusText}`);
        }

        const data = await response.json();
        if (!data.data || !data.data[0]) throw new Error('è¿”å›æ•°æ®å¼‚å¸¸ï¼šæœªæ‰¾åˆ°å›¾åƒ');

        const imageData = data.data[0];
        let blob;

        if (imageData.url) {
          showStatus('ğŸ“¥ æ­£åœ¨ä¸‹è½½å›¾åƒ...', 'info');
          const imgRes = await fetch(imageData.url);
          if (!imgRes.ok) throw new Error(`ä¸‹è½½å¤±è´¥: ${imgRes.statusText}`);
          blob = await imgRes.blob();
        } else if (imageData.b64_json) {
          const binary = atob(imageData.b64_json);
          const bytes = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
          blob = new Blob([bytes], { type: 'image/jpeg' });
        } else {
          throw new Error('æ— æœ‰æ•ˆå›¾åƒæ•°æ®ï¼ˆç¼ºå°‘ url æˆ– b64_jsonï¼‰');
        }

        // ä¿å­˜åˆ°çŠ¶æ€ & UI
        state.images.push(blob);
        setImage(blob);
        showStatus('âœ… å›¾åƒç”ŸæˆæˆåŠŸï¼å¯é€šè¿‡æ»šè½®ç¼©æ”¾ã€æ‹–æ‹½æŸ¥çœ‹ç»†èŠ‚', 'success');
        el.downloadBtn.disabled = false;
        localStorage.setItem('apiKey', apiKey); // ä¸´æ—¶è®°ä½ key

      } catch (err) {
        console.error(err);
        showStatus(`âŒ ç”Ÿæˆå¤±è´¥ï¼š${err.message}`, 'error');
      } finally {
        el.generateBtn.disabled = false;
      }
    }

    // ========== ä¸‹è½½ ZIPï¼ˆå…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼‰==========
    async function downloadAsZip() {
      if (state.images.length === 0) return;

      try {
        showStatus('ğŸ“¦ æ­£åœ¨æ‰“åŒ… ZIP...', 'info');

        // åŠ¨æ€åŠ è½½ JSZipï¼ˆCDNï¼‰
        if (typeof JSZip === 'undefined') {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            script.onload = resolve;
            script.onerror = () => reject(new Error('JSZip åŠ è½½å¤±è´¥'));
            document.head.appendChild(script);
          });
        }

        const zip = new JSZip();
        const folder = zip.folder('generated_images');

        for (let i = 0; i < state.images.length; i++) {
          const blob = state.images[i];
          const name = `image_${Date.now()}_${i + 1}.jpg`;
          folder.file(name, blob);
        }

        const content = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(content);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ai_images_${new Date().toISOString().slice(0,10)}.zip`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);

        showStatus('âœ… ZIP ä¸‹è½½å®Œæˆï¼', 'success');
      } catch (err) {
        console.error(err);
        showStatus(`âŒ ZIP æ‰“åŒ…å¤±è´¥ï¼š${err.message}`, 'error');
      }
    }

    // ========== äº¤äº’ç»‘å®š ==========
    el.generateBtn.addEventListener('click', generateImage);
    el.downloadBtn.addEventListener('click', downloadAsZip);

    el.resetBtn.addEventListener('click', () => {
      el.prompt.value = '';
      state.images = [];
      state.imageBlob = null;
      if (state.imageUrl) {
        URL.revokeObjectURL(state.imageUrl);
        state.imageUrl = null;
      }
      el.imageView.style.display = 'none';
      el.placeholder.style.display = 'block';
      el.downloadBtn.disabled = true;
      hideStatus();
    });

    // ========== å›¾åƒäº¤äº’ï¼ˆæ‹–æ‹½ + ç¼©æ”¾ï¼‰==========
    const container = el.imageContainer;
    const img = el.imageView;

    container.addEventListener('mousedown', (e) => {
      if (e.button !== 0) return; // ä»…å·¦é”®
      state.isDragging = true;
      state.dragStart = { x: e.clientX - state.panX, y: e.clientY - state.panY };
      container.classList.add('dragging');
      e.preventDefault();
    });

    window.addEventListener('mousemove', (e) => {
      if (!state.isDragging) return;
      state.panX = e.clientX - state.dragStart.x;
      state.panY = e.clientY - state.dragStart.y;
      applyTransform();
    });

    window.addEventListener('mouseup', () => {
      state.isDragging = false;
      container.classList.remove('dragging');
    });

    container.addEventListener('wheel', (e) => {
      if (!state.imageBlob) return;

      e.preventDefault();
      const delta = e.deltaY > 0 ? -0.1 : 0.1; // ç¼©æ”¾æ­¥é•¿
      const newZoom = Math.min(20, Math.max(0.1, state.zoom + delta)); // 10% ~ 2000%

      // è®¡ç®—ç¼©æ”¾ä¸­å¿ƒï¼ˆé¼ æ ‡ä½ç½®ï¼‰
      const rect = container.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      // ç¼©æ”¾æ—¶ä¿æŒé¼ æ ‡ç‚¹ä¸åŠ¨ï¼ˆå…³é”®ï¼ï¼‰
      const zoomFactor = newZoom / state.zoom;
      state.panX = mouseX - (mouseX - state.panX) * zoomFactor;
      state.panY = mouseY - (mouseY - state.panY) * zoomFactor;

      state.zoom = newZoom;
      applyTransform();
      updateZoomDisplay();
    }, { passive: false });

    // ç¦æ­¢å›¾ç‰‡é»˜è®¤æ‹–æ‹½
    img.addEventListener('dragstart', (e) => e.preventDefault());
  </script>
</body>
</html>