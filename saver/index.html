<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>44 队伍存档器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .team-section {
            flex: 1;
            background: rgba(0, 0, 0, 0.25);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .team-title {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .blue-team .team-title { color: #4da6ff; }
        .red-team .team-title { color: #ff4d4d; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .slot {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .slot:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .slot.selected {
            box-shadow: 0 0 0 3px yellow;
        }
        
        .blue-team .slot {
            background: rgba(77, 166, 255, 0.2);
            border: 2px solid #4da6ff;
        }
        
        .red-team .slot {
            background: rgba(255, 77, 77, 0.2);
            border: 2px solid #ff4d4d;
        }
        
        .slot img {
            width: 80%;
            height: 80%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .slot-number {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.5);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
        }
        
        .selected-characters {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .selected-title {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .characters-list {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .character-item {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .character-item:hover {
            transform: scale(1.1);
        }
        
        .character-item.selected {
            border-color: yellow;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-win {
            background: linear-gradient(to right, #4CAF50, #2E7D32);
            color: white;
        }
        
        .btn-lose {
            background: linear-gradient(to right, #F44336, #C62828);
            color: white;
        }
        
        .btn-query {
            background: linear-gradient(to right, #2196F3, #0D47A1);
            color: white;
        }
        
        .btn-delete {
            background: linear-gradient(to right, #9E9E9E, #424242);
            color: white;
        }
        
        .btn-nav {
            background: linear-gradient(to right, #FF9800, #E65100);
            color: white;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .checkbox-container input {
            margin-right: 10px;
            transform: scale(1.3);
        }
        
        .results-section {
            background: rgba(0, 0, 0, 0.25);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .results-title {
            font-size: 1.5rem;
        }
        
        .results-info {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .win { color: #4CAF50; }
        .lose { color: #F44336; }
        .match { color: #2196F3; }
        .no-match { color: #FF9800; }
        
        .navigation {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .character-placeholder {
            width: 80%;
            height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .swap-btn {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: #3498db;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .grid {
                gap: 8px;
            }
            
            .slot {
                min-height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>44 队伍存档器</h1>
            <p class="subtitle">保存、查询和管理你的 44 历史记录</p>
        </header>
        
        <div class="main-content">
            <!-- 蓝色队伍区域 -->
            <div class="team-section blue-team">
                <div class="team-header">
                    <div class="team-title">我方队伍</div>
                    <div class="team-count">已选: <span id="blue-count">0</span>/4</div>
                </div>
                
                <div class="grid" id="blue-grid">
                    <!-- 5行4列的方块将通过JS生成 -->
                </div>
                
                <div class="selected-characters">
                    <div class="selected-title">已选角色:</div>
                    <div class="characters-list" id="blue-selected-list">
                        <!-- 已选角色将显示在这里 -->
                    </div>
                </div>
            </div>
            
            <!-- 红色队伍区域 -->
            <div class="team-section red-team">
                <div class="team-header">
                    <div class="team-title">敌方队伍</div>
                    <div class="team-count">已选: <span id="red-count">0</span>/4</div>
                </div>
                
                <div class="grid" id="red-grid">
                    <!-- 5行4列的方块将通过JS生成 -->
                </div>
                
                <div class="selected-characters">
                    <div class="selected-title">已选角色:</div>
                    <div class="characters-list" id="red-selected-list">
                        <!-- 已选角色将显示在这里 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 控制按钮 -->
        <div class="controls">
            <button class="btn btn-query" id="query-btn">查询匹配阵容</button>
            <div class="checkbox-container">
                <input type="checkbox" id="save-order-checkbox">
                <label for="save-order-checkbox">保存角色排列顺序</label>
            </div>
            <button class="btn btn-win" id="save-win-btn" disabled>保存为胜利</button>
            <button class="btn btn-lose" id="save-lose-btn" disabled>保存为失败</button>
        </div>
        
        <!-- 查询结果区域 -->
        <div class="results-section" id="results-section">
            <div class="results-header">
                <div class="results-title">匹配结果</div>
                <button class="btn btn-delete" id="delete-btn">删除当前记录</button>
            </div>
            
            <div class="results-info">
                <div class="info-item">匹配ID: <span id="match-id">-</span></div>
                <div class="info-item">结果: <span id="match-result" class="win">胜利</span></div>
                <div class="info-item">顺序匹配: <span id="order-match" class="match">是</span></div>
                <div class="info-item">总匹配数: <span id="total-matches">0</span></div>
                <div class="info-item">当前: <span id="current-match">0</span>/<span id="total-matches-2">0</span></div>
            </div>
            
            <div class="navigation">
                <button class="btn btn-nav" id="prev-btn">← 上一个</button>
                <button class="btn btn-nav" id="next-btn">下一个 →</button>
            </div>
        </div>
    </div>

    <script>
        // 角色数据（模拟角色头像）
        const characters = [
            { id: 1, name: "伊娃", color: "#777777" },
            { id: 2, name: "银河", color: "#777777" },
            { id: 3, name: "黛西", color: "#7777ff" },
            { id: 4, name: "贝丝", color: "#ff77ff" },
            { id: 5, name: "莉耶", color: "#777777" },
            { id: 6, name: "加百列", color: "#ffff77" },
            { id: 7, name: "艾丝黛尔", color: "#77ff77" },
            { id: 8, name: "卡麦尔", color: "#77ff77" },
            { id: 9, name: "阿拉贝尔", color: "#ff77ff" },
            { id: 10, name: "瑜娜", color: "#77ff77" },
            { id: 11, name: "J", color: "#7777ff" },
            { id: 12, name: "卡莉", color: "#ff77ff" },
            { id: 13, name: "美娅", color: "#ff7777" },
            { id: 14, name: "比什巴赫", color: "#ff7777" },
            { id: 15, name: "未来公主", color: "#ffff77" },
            { id: 16, name: "凯登", color: "#ff77ff" },
            { id: 17, name: "兰迪", color: "#ff7777" },
        ];
        
        // 初始化队伍数据
        let blueTeam = Array(20).fill(null); // 5x4 = 20 slots
        let redTeam = Array(20).fill(null);

        let blueDisplayOrder = [];
        let redDisplayOrder = [];
        
        // 当前选中的方块
        let selectedSlot = null;
        let selectedTeam = null; // 'blue' or 'red'
        
        // 查询结果相关
        let queryResults = [];
        let currentResultIndex = -1;
        
        let blueFirstCharId = null;
        let redFirstCharId = null;
        
        let usePortrait = true; // 默认使用头像显示
        
        // DOM元素
        const blueGrid = document.getElementById('blue-grid');
        const redGrid = document.getElementById('red-grid');
        const blueSelectedList = document.getElementById('blue-selected-list');
        const redSelectedList = document.getElementById('red-selected-list');
        const blueCount = document.getElementById('blue-count');
        const redCount = document.getElementById('red-count');
        const saveWinBtn = document.getElementById('save-win-btn');
        const saveLoseBtn = document.getElementById('save-lose-btn');
        const queryBtn = document.getElementById('query-btn');
        const saveOrderCheckbox = document.getElementById('save-order-checkbox');
        const resultsSection = document.getElementById('results-section');
        const matchId = document.getElementById('match-id');
        const matchResult = document.getElementById('match-result');
        const orderMatch = document.getElementById('order-match');
        const totalMatches = document.getElementById('total-matches');
        const currentMatch = document.getElementById('current-match');
        const totalMatches2 = document.getElementById('total-matches-2');
        const deleteBtn = document.getElementById('delete-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        // 获取方阵中的非空角色（最多4个）
        function getNonEmptyCharacters(teamArray) {
            const nonEmpty = teamArray.filter(id => id !== null);
            return nonEmpty.length <= 4 ? nonEmpty : nonEmpty.slice(0, 4);
        }
        
        // 初始化网格
        function initGrid() {
            // 创建蓝色队伍网格
            blueGrid.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.dataset.index = i;
                slot.dataset.team = 'blue';
                slot.innerHTML = `<div class="slot-number">${i+1}</div>`;
                slot.addEventListener('click', () => handleSlotClick(slot, 'blue', i));
                blueGrid.appendChild(slot);
            }
            
            // 创建红色队伍网格
            redGrid.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.dataset.index = i;
                slot.dataset.team = 'red';
                slot.innerHTML = `<div class="slot-number">${i+1}</div>`;
                slot.addEventListener('click', () => handleSlotClick(slot, 'red', i));
                redGrid.appendChild(slot);
            }
        }
        
        // 处理方块点击
        function handleSlotClick(slot, team, index) {
            // 如果当前有选中的方块，先取消选中
            if (selectedSlot && selectedSlot !== slot) {
                selectedSlot.classList.remove('selected');
            }
            
            // 如果点击的是已有角色的格子，直接清除角色
            if ((team === 'blue' && blueTeam[index] !== null) || (team === 'red' && redTeam[index] !== null)) {
                // 如果这是当前选中的格子，取消选中并清除
                if (selectedSlot === slot) {
                    removeCharacter(team, index);
                    selectedSlot = null;
                    selectedTeam = null;
                } 
                // 如果不是当前选中的格子，直接清除
                else {
                    removeCharacter(team, index);
                    // 保持当前选中状态（如果有）
                }
                return;
            }
            
            // 如果点击的是空格子
            if (selectedSlot === slot) {
                // 取消选中
                selectedSlot.classList.remove('selected');
                selectedSlot = null;
                selectedTeam = null;
            } else {
                // 选中当前方块并显示角色选择列表
                selectedSlot = slot;
                selectedTeam = team;
                slot.classList.add('selected');
                showCharacterList(team);
            }
        }
        
        // 移除角色
        function removeCharacter(team, index) {
            const charId = team === 'blue' ? blueTeam[index] : redTeam[index];
            if (charId === null) return;

            // 从方阵移除
            if (team === 'blue') {
                blueTeam[index] = null;
            } else {
                redTeam[index] = null;
            }

            // 从 displayOrder 中移除该角色
            const displayOrder = team === 'blue' ? blueDisplayOrder : redDisplayOrder;
            const orderIndex = displayOrder.indexOf(charId);
            if (orderIndex !== -1) {
                displayOrder.splice(orderIndex, 1);
            }

            // 更新UI
            updateGrid();
            updateSelectedList(team);
            updateCount(team);
            checkSaveAvailability();
        }

        // 显示角色选择列表
        function showCharacterList(team) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = '#2c3e50';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.maxWidth = '500px';
            modalContent.style.width = '90%';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflowY = 'auto';
            
            const title = document.createElement('h3');
            title.textContent = `选择${team === 'blue' ? '我方' : '敌方'}队伍角色`;
            title.style.marginBottom = '15px';
            title.style.color = team === 'blue' ? '#4da6ff' : '#ff4d4d';
            modalContent.appendChild(title);
            
            const characterGrid = document.createElement('div');
            characterGrid.style.display = 'grid';
            characterGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(80px, 1fr))';
            characterGrid.style.gap = '15px';
            
            // 获取当前队伍已使用的角色ID
            const usedChars = team === 'blue' ? 
                blueTeam.filter(id => id !== null) : 
                redTeam.filter(id => id !== null);
            
            characters.forEach(char => {
                const charItem = document.createElement('div');
                charItem.className = 'character-item';
                charItem.style.display = 'flex';
                charItem.style.justifyContent = 'center';
                charItem.style.alignItems = 'center';
                charItem.style.position = 'relative';
                charItem.style.cursor = 'pointer';
                charItem.style.borderRadius = '8px';
                charItem.style.overflow = 'hidden';
                
                if (usePortrait) {
                    // 使用头像显示
                    const img = document.createElement('img');
                    img.src = `portrait/${char.id}.png`;
                    img.alt = char.name;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    charItem.appendChild(img);
                } else {
                    // 使用文字显示 - 调整文字颜色和尺寸
                    charItem.style.backgroundColor = char.color;
                    charItem.style.color = getContrastColor(char.color);
                    charItem.style.fontSize = getFontSize(char.name);
                    charItem.style.fontWeight = 'bold';
                    charItem.style.textAlign = 'center';
                    charItem.style.padding = '5px';
                    charItem.textContent = char.name;
                }
                
                // 如果角色已在队伍中使用，添加选中样式
                if (usedChars.includes(char.id)) {
                    charItem.style.boxShadow = '0 0 0 3px yellow';
                }
                
                charItem.addEventListener('click', () => {
                    selectCharacter(char.id, team);
                    document.body.removeChild(modal);
                });
                
                characterGrid.appendChild(charItem);
            });
            
            modalContent.appendChild(characterGrid);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    if (selectedSlot) {
                        selectedSlot.classList.remove('selected');
                        selectedSlot = null;
                        selectedTeam = null;
                    }
                }
            });
        }

        function getContrastColor(bgColor) {
            // 将十六进制颜色转换为RGB
            let hex = bgColor.replace('#', '');
            if (hex.length === 3) {
                hex = hex.split('').map(c => c + c).join('');
            }
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            
            // 计算亮度
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            
            // 如果亮度大于128，使用深色文字，否则使用浅色文字
            return brightness > 128 ? '#000000' : '#ffffff';
        }

        // 辅助函数：根据文字长度调整字体大小
        function getFontSize(text) {
            const length = text.length;
            if (length <= 2) return '14px';
            if (length <= 3) return '12px';
            if (length <= 4) return '11px';
            return '10px';
        }
        
        // 选择角色
        function selectCharacter(charId, team) {
            if (!selectedSlot || selectedTeam !== team) return;
            const index = parseInt(selectedSlot.dataset.index);
            const currentTeam = team === 'blue' ? blueTeam : redTeam;
            const existingIndex = currentTeam.indexOf(charId);

            // 获取当前 display order
            const displayOrder = team === 'blue' ? blueDisplayOrder : redDisplayOrder;

            if (existingIndex !== -1) {
                // 角色已存在：移动位置（方阵更新，排列表顺序不变）
                if (team === 'blue') {
                    blueTeam[existingIndex] = null;
                    blueTeam[index] = charId;
                } else {
                    redTeam[existingIndex] = null;
                    redTeam[index] = charId;
                }
                // 排列表顺序不变，无需修改 displayOrder
            } else {
                // 角色不存在：检查是否超限
                if (displayOrder.length >= 4) {
                    alert('每个队伍最多只能有4个角色！');
                    return;
                }
                // 添加到方阵
                if (team === 'blue') {
                    blueTeam[index] = charId;
                } else {
                    redTeam[index] = charId;
                }
                // 追加到排列表末尾
                displayOrder.push(charId);
            }

            // 更新UI
            updateGrid();
            updateSelectedList(team);
            updateCount(team);
            checkSaveAvailability();

            // 取消选中
            selectedSlot.classList.remove('selected');
            selectedSlot = null;
            selectedTeam = null;
        }

        
        // 更新网格显示
        function updateGrid() {
            const blueFirstChar = blueDisplayOrder[0] || null;
            const redFirstChar = redDisplayOrder[0] || null;
            // 蓝色队伍
            const blueSlots = document.querySelectorAll('[data-team="blue"]');
            blueSlots.forEach((slot, index) => {
                slot.innerHTML = `<div class="slot-number">${index+1}</div>`;
                if (blueTeam[index] !== null) {
                    const char = characters.find(c => c.id === blueTeam[index]);
                    if (char) {
                        const charDiv = document.createElement('div');
                        charDiv.style.width = '80%';
                        charDiv.style.height = '80%';
                        charDiv.style.borderRadius = '8px';
                        charDiv.style.display = 'flex';
                        charDiv.style.justifyContent = 'center';
                        charDiv.style.alignItems = 'center';
                        charDiv.style.color = 'white';
                        charDiv.style.position = 'relative';
                        if (usePortrait) {
                            const img = document.createElement('img');
                            img.src = `portrait/${char.id}.png`;
                            img.alt = char.name;
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '8px';
                            charDiv.appendChild(img);
                        } else {
                            charDiv.style.backgroundColor = char.color;
                            charDiv.textContent = char.name;
                        }
                        if (blueTeam[index] === blueFirstChar) {
                            charDiv.style.boxShadow = '0 0 10px 3px #FFD700';
                            charDiv.style.border = '2px solid #FFD700';
                        }
                        slot.appendChild(charDiv);
                    }
                }
            });

            // 红色队伍（同理）
            const redSlots = document.querySelectorAll('[data-team="red"]');
            redSlots.forEach((slot, index) => {
                slot.innerHTML = `<div class="slot-number">${index+1}</div>`;
                if (redTeam[index] !== null) {
                    const char = characters.find(c => c.id === redTeam[index]);
                    if (char) {
                        const charDiv = document.createElement('div');
                        charDiv.style.width = '80%';
                        charDiv.style.height = '80%';
                        charDiv.style.borderRadius = '8px';
                        charDiv.style.display = 'flex';
                        charDiv.style.justifyContent = 'center';
                        charDiv.style.alignItems = 'center';
                        charDiv.style.color = 'white';
                        charDiv.style.position = 'relative';
                        if (usePortrait) {
                            const img = document.createElement('img');
                            img.src = `portrait/${char.id}.png`;
                            img.alt = char.name;
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '8px';
                            charDiv.appendChild(img);
                        } else {
                            charDiv.style.backgroundColor = char.color;
                            charDiv.textContent = char.name;
                        }
                        if (redTeam[index] === redFirstChar) {
                            charDiv.style.boxShadow = '0 0 10px 3px #FFD700';
                            charDiv.style.border = '2px solid #FFD700';
                        }
                        slot.appendChild(charDiv);
                    }
                }
            });
        }
        
        // 更新已选角色列表（从方阵中提取非空角色）
        function updateSelectedList(team) {
            const list = team === 'blue' ? blueSelectedList : redSelectedList;
            const displayOrder = team === 'blue' ? blueDisplayOrder : redDisplayOrder;
            list.innerHTML = '';
            const firstCharId = displayOrder[0] || null;
            displayOrder.forEach((charId, index) => {
                const char = characters.find(c => c.id === charId);
                if (char) {
                    const charItem = document.createElement('div');
                    charItem.className = 'character-item';
                    charItem.style.display = 'flex';
                    charItem.style.justifyContent = 'center';
                    charItem.style.alignItems = 'center';
                    charItem.style.position = 'relative';
                    if (usePortrait) {
                        const img = document.createElement('img');
                        img.src = `portrait/${char.id}.png`;
                        img.alt = char.name;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '8px';
                        charItem.appendChild(img);
                    } else {
                        charItem.style.backgroundColor = char.color;
                        charItem.style.color = getContrastColor(char.color);
                        charItem.style.fontSize = getFontSize(char.name);
                        charItem.style.fontWeight = 'bold';
                        charItem.style.textAlign = 'center';
                        charItem.style.padding = '5px';
                        charItem.textContent = char.name;
                    }
                    if (charId === firstCharId) {
                        charItem.style.boxShadow = '0 0 8px 2px #FFD700';
                        charItem.style.border = '2px solid #FFD700';
                    }
                    if (index > 0) {
                        const swapBtn = document.createElement('div');
                        swapBtn.className = 'swap-btn';
                        swapBtn.textContent = '↑';
                        swapBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            // 交换 displayOrder 中的两个角色
                            const order = team === 'blue' ? blueDisplayOrder : redDisplayOrder;
                            [order[index], order[index - 1]] = [order[index - 1], order[index]];
                            updateSelectedList(team);
                            updateGrid(); // 更新高亮
                        });
                        charItem.appendChild(swapBtn);
                    }
                    list.appendChild(charItem);
                }
            });
        }
                
        // 更新计数
        function updateCount(team) {
            const count = getNonEmptyCharacters(team === 'blue' ? blueTeam : redTeam).length;
            if (team === 'blue') {
                blueCount.textContent = count;
            } else {
                redCount.textContent = count;
            }
        }
        
        // 检查是否可以保存
        function checkSaveAvailability() {
            const blueCount = getNonEmptyCharacters(blueTeam).length;
            const redCount = getNonEmptyCharacters(redTeam).length;
            const canSave = blueCount === 4 && redCount === 4;
            saveWinBtn.disabled = !canSave;
            saveLoseBtn.disabled = !canSave;
        }
        
        // 保存数据
        function saveData(result) {
            const data = {
                blueTeam: [...blueTeam],
                redTeam: [...redTeam],
                blueDisplayOrder: [...blueDisplayOrder], // 新增
                redDisplayOrder: [...redDisplayOrder],   // 新增
                result: result,
                timestamp: new Date().getTime()
            };
            let savedData = JSON.parse(localStorage.getItem('teamArchives') || '[]');
            savedData.push(data);
            localStorage.setItem('teamArchives', JSON.stringify(savedData));
            alert(`阵容已保存为${result === 'win' ? '胜利' : '失败'}!`);
        }
        
        function flipTeamVertically(teamArray) {
            // 5行4列，上下轴对称意味着第0行和第4行交换，第1行和第3行交换，第2行不变
            const flipped = Array(20).fill(null);
            
            // 行索引映射：0->4, 1->3, 2->2, 3->1, 4->0
            const rowMap = [4, 3, 2, 1, 0];
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 4; col++) {
                    const originalIndex = row * 4 + col;
                    const flippedRow = rowMap[row];
                    const flippedIndex = flippedRow * 4 + col;
                    flipped[flippedIndex] = teamArray[originalIndex];
                }
            }
            
            return flipped;
        }

        function flipTeamHorizontally(teamArray) {
            const flipped = Array(20).fill(null);
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 4; col++) {
                    const originalIndex = row * 4 + col;
                    const flippedCol = 3 - col; // 0<->3, 1<->2
                    const flippedIndex = row * 4 + flippedCol;
                    flipped[flippedIndex] = teamArray[originalIndex];
                }
            }
            return flipped;
        }

        function flipTeam(team, direction) {
            if (team === 'blue') {
                if (direction === 'vertical') {
                    blueTeam = flipTeamVertically(blueTeam);
                } else if (direction === 'horizontal') {
                    blueTeam = flipTeamHorizontally(blueTeam);
                }
                // 注意：displayOrder 不变！
            } else {
                if (direction === 'vertical') {
                    redTeam = flipTeamVertically(redTeam);
                } else if (direction === 'horizontal') {
                    redTeam = flipTeamHorizontally(redTeam);
                }
                // displayOrder 不变！
            }
            updateGrid(); // 会根据 displayOrder[0] 高亮首位
            updateSelectedList(team); // 列表顺序不变
            updateCount(team);
            checkSaveAvailability();
        }

        function swapTeams() {
            // 交换方阵（并镜像）
            const newBlueTeam = flipTeamHorizontally([...redTeam]);
            const newRedTeam = flipTeamHorizontally([...blueTeam]);

            // 交换 displayOrder（不改变内部顺序）
            const newBlueDisplayOrder = [...redDisplayOrder];
            const newRedDisplayOrder = [...blueDisplayOrder];

            // 应用
            blueTeam = newBlueTeam;
            redTeam = newRedTeam;
            blueDisplayOrder = newBlueDisplayOrder;
            redDisplayOrder = newRedDisplayOrder;

            // 更新UI
            updateGrid();
            updateSelectedList('blue');
            updateSelectedList('red');
            updateCount('blue');
            updateCount('red');
            checkSaveAvailability();

            // 取消选中
            if (selectedSlot) {
                selectedSlot.classList.remove('selected');
                selectedSlot = null;
                selectedTeam = null;
            }
        }

        // 查询匹配阵容
        function queryMatches() {
            const redSelected = getNonEmptyCharacters(redTeam);
            if (redSelected.length !== 4) {
                alert('请先在红色队伍中选择4个角色!');
                return;
            }
            const savedData = JSON.parse(localStorage.getItem('teamArchives') || '[]');
            if (savedData.length === 0) {
                alert('没有保存的阵容数据!');
                return;
            }

            const currentRedFirstChar = redDisplayOrder[0];
            const saveOrder = saveOrderCheckbox.checked;
            const currentRedTeam = [...redTeam];
            const currentRedTeamFlipped = flipTeamVertically(currentRedTeam);

            const matches = [];
            savedData.forEach((record, recordIndex) => {
                // 兼容旧数据（无 displayOrder 字段）
                const recordRedDisplayOrder = record.redDisplayOrder || getNonEmptyCharacters(record.redTeam);
                const recordFirstChar = recordRedDisplayOrder[0];

                // 首位角色必须匹配（强制）
                if (currentRedFirstChar !== recordFirstChar) {
                    return;
                }

                let isFlippedMatch = false;
                let redMatch = currentRedTeam.every((charId, i) => charId === record.redTeam[i]);

                if (!redMatch) {
                    redMatch = currentRedTeamFlipped.every((charId, i) => charId === record.redTeam[i]);
                    if (redMatch) isFlippedMatch = true;
                }

                if (!redMatch) return;

                // 顺序匹配（如果启用）
                let orderMatch = true;
                if (saveOrder) {
                    const currentOrder = isFlippedMatch ? 
                        getNonEmptyCharacters(currentRedTeamFlipped) : 
                        redDisplayOrder;
                    orderMatch = currentOrder.length === recordRedDisplayOrder.length &&
                                currentOrder.every((id, i) => id === recordRedDisplayOrder[i]);
                }

                matches.push({
                    ...record,
                    isFlippedMatch,
                    orderMatch,
                    originalIndex: recordIndex
                });
            });

            if (matches.length === 0) {
                alert('没有找到匹配的阵容!');
                resultsSection.style.display = 'none';
                return;
            }

            // 排序逻辑（不变）
            matches.sort((a, b) => {
                if (a.result === 'win' && b.result !== 'win') return -1;
                if (a.result !== 'win' && b.result === 'win') return 1;
                if (!a.isFlippedMatch && b.isFlippedMatch) return -1;
                if (a.isFlippedMatch && !b.isFlippedMatch) return 1;
                if (saveOrder) {
                    if (a.orderMatch && !b.orderMatch) return -1;
                    if (!a.orderMatch && b.orderMatch) return 1;
                }
                return 0;
            });

            queryResults = matches;
            currentResultIndex = 0;
            displayCurrentResult();
            resultsSection.style.display = 'block';
        }
        
        // 显示当前查询结果
        function displayCurrentResult() {
            if (currentResultIndex < 0 || currentResultIndex >= queryResults.length) return;
            const result = queryResults[currentResultIndex];

            matchId.textContent = currentResultIndex + 1;
            matchResult.textContent = result.result === 'win' ? '胜利' : '失败';
            matchResult.className = result.result === 'win' ? 'win' : 'lose';

            const saveOrder = saveOrderCheckbox.checked;
            let matchTypeText = result.isFlippedMatch ? '轴对称匹配' : '完全匹配';
            if (result.isFlippedMatch) matchTypeText += ' (已翻转)';

            if (saveOrder) {
                const orderMatchText = result.orderMatch ? '是' : '否';
                orderMatch.textContent = `${orderMatchText} (${matchTypeText})`;
                orderMatch.className = result.orderMatch ? 'match' : 'no-match';
            } else {
                orderMatch.textContent = matchTypeText;
                orderMatch.className = 'match';
            }

            totalMatches.textContent = queryResults.length;
            totalMatches2.textContent = queryResults.length;
            currentMatch.textContent = currentResultIndex + 1;

            // 更新蓝色方阵
            let blueTeamToDisplay = [...result.blueTeam];
            if (result.isFlippedMatch) {
                blueTeamToDisplay = flipTeamVertically(blueTeamToDisplay);
            }
            blueTeam = blueTeamToDisplay;

            // ✅ 关键：使用保存的 blueDisplayOrder（兼容旧数据）
            blueDisplayOrder = result.blueDisplayOrder || getNonEmptyCharacters(blueTeam);

            updateGrid();
            updateSelectedList('blue');
            updateCount('blue');
        }
        
        // 删除当前查询结果
        function deleteCurrentResult() {
            if (currentResultIndex < 0 || currentResultIndex >= queryResults.length) return;
            
            const confirmDelete = confirm('确定要删除这个记录吗？');
            if (!confirmDelete) return;
            
            // 从localStorage中删除
            let savedData = JSON.parse(localStorage.getItem('teamArchives') || '[]');
            const resultToDelete = queryResults[currentResultIndex];
            
            // 找到并删除
            const indexToDelete = savedData.findIndex(record => 
                JSON.stringify(record) === JSON.stringify(resultToDelete)
            );
            
            if (indexToDelete !== -1) {
                savedData.splice(indexToDelete, 1);
                localStorage.setItem('teamArchives', JSON.stringify(savedData));
            }
            
            // 从查询结果中移除
            queryResults.splice(currentResultIndex, 1);
            
            if (queryResults.length === 0) {
                resultsSection.style.display = 'none';
                // 重置蓝色队伍
                blueTeam = Array(20).fill(null);
                updateGrid();
                updateSelectedList('blue');
                updateCount('blue');
            } else {
                // 调整当前索引
                if (currentResultIndex >= queryResults.length) {
                    currentResultIndex = queryResults.length - 1;
                }
                displayCurrentResult();
            }
        }

        function optimizeDatabase() {
            const savedData = JSON.parse(localStorage.getItem('teamArchives') || '[]');
            if (savedData.length === 0) {
                alert('数据库为空，无需优化。');
                return;
            }

            const seen = new Set();
            const uniqueData = [];

            for (const record of savedData) {
                // 构造用于比较的标准化字符串（包含 blueTeam, redTeam, result）
                const key = JSON.stringify({
                    blueTeam: record.blueTeam,
                    redTeam: record.redTeam,
                    result: record.result
                });
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueData.push(record);
                }
            }

            const removedCount = savedData.length - uniqueData.length;
            if (removedCount > 0) {
                localStorage.setItem('teamArchives', JSON.stringify(uniqueData));
                alert(`数据库优化完成！已移除 ${removedCount} 条重复记录，剩余 ${uniqueData.length} 条。`);
                // 如果当前正在查看查询结果，刷新结果
                if (resultsSection.style.display === 'block') {
                    queryMatches();
                }
            } else {
                alert('数据库中无重复记录，无需优化。');
            }
        }
        
        // 初始化

        // 在 init 函数中添加清除按钮
        // 修改 init 函数，添加复选框和调整按钮样式
        function init() {
            initGrid();
            updateGrid();
            checkSaveAvailability();
            
            // 添加显示模式复选框
            const checkboxContainer = document.querySelector('.checkbox-container');
            const portraitCheckbox = document.createElement('div');
            portraitCheckbox.style.marginLeft = '20px';
            portraitCheckbox.innerHTML = `
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="portrait-checkbox" checked style="margin-right: 8px; transform: scale(1.1);">
                    <span>使用头像显示</span>
                </label>
            `;
            checkboxContainer.appendChild(portraitCheckbox);
            
            document.getElementById('portrait-checkbox').addEventListener('change', (e) => {
                usePortrait = e.target.checked;
                updateGrid();
                updateSelectedList('blue');
                updateSelectedList('red');
            });
            
            // 添加清除按钮到DOM（调整样式）
            const blueTeamSection = document.querySelector('.blue-team .team-header');
            const redTeamSection = document.querySelector('.red-team .team-header');
            
            const blueClearBtn = document.createElement('button');
            blueClearBtn.className = 'btn btn-delete';
            blueClearBtn.style.padding = '4px 8px';
            blueClearBtn.style.fontSize = '0.75rem';
            blueClearBtn.style.minWidth = 'auto';
            blueClearBtn.style.width = 'auto';
            blueClearBtn.textContent = '清空';
            blueClearBtn.addEventListener('click', () => clearTeam('blue'));
            blueTeamSection.appendChild(blueClearBtn);
            
            const redClearBtn = document.createElement('button');
            redClearBtn.className = 'btn btn-delete';
            redClearBtn.style.padding = '4px 8px';
            redClearBtn.style.fontSize = '0.75rem';
            redClearBtn.style.minWidth = 'auto';
            redClearBtn.style.width = 'auto';
            redClearBtn.textContent = '清空';
            redClearBtn.addEventListener('click', () => clearTeam('red'));
            redTeamSection.appendChild(redClearBtn);

            const blueFlipBtn = document.createElement('button');
            blueFlipBtn.className = 'btn btn-nav';
            blueFlipBtn.style.padding = '4px 8px';
            blueFlipBtn.style.fontSize = '0.75rem';
            blueFlipBtn.style.minWidth = 'auto';
            blueFlipBtn.style.width = 'auto';
            blueFlipBtn.textContent = '上下翻转';
            blueFlipBtn.addEventListener('click', () => flipTeam('blue', 'vertical'));
            blueTeamSection.appendChild(blueFlipBtn);

            // 添加上下翻转按钮（红色）
            const redFlipBtn = document.createElement('button');
            redFlipBtn.className = 'btn btn-nav';
            redFlipBtn.style.padding = '4px 8px';
            redFlipBtn.style.fontSize = '0.75rem';
            redFlipBtn.style.minWidth = 'auto';
            redFlipBtn.style.width = 'auto';
            redFlipBtn.textContent = '上下翻转';
            redFlipBtn.addEventListener('click', () => flipTeam('red', 'vertical'));
            redTeamSection.appendChild(redFlipBtn);

            // 添加敌我互换按钮（放在控制区上方）
            const swapTeamsBtn = document.createElement('button');
            swapTeamsBtn.className = 'btn btn-nav';
            swapTeamsBtn.textContent = '敌我互换';
            swapTeamsBtn.style.marginTop = '10px';
            swapTeamsBtn.style.width = '100%';
            swapTeamsBtn.addEventListener('click', swapTeams);
            
            // 调整删除按钮样式
            deleteBtn.style.padding = '8px 12px';
            deleteBtn.style.fontSize = '0.9rem';
            deleteBtn.style.minWidth = 'auto';
            
            // 事件监听
            saveWinBtn.addEventListener('click', () => saveData('win'));
            saveLoseBtn.addEventListener('click', () => saveData('lose'));
            queryBtn.addEventListener('click', queryMatches);
            deleteBtn.addEventListener('click', deleteCurrentResult);
            prevBtn.addEventListener('click', () => {
                if (currentResultIndex > 0) {
                    currentResultIndex--;
                    displayCurrentResult();
                }
            });
            nextBtn.addEventListener('click', () => {
                if (currentResultIndex < queryResults.length - 1) {
                    currentResultIndex++;
                    displayCurrentResult();
                }
            });

            const controls = document.querySelector('.controls');
            controls.parentNode.insertBefore(swapTeamsBtn, controls);
            const exportImportContainer = document.createElement('div');
            exportImportContainer.style.display = 'flex';
            exportImportContainer.style.gap = '10px';
            exportImportContainer.style.marginTop = '10px';
            
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn btn-nav';
            exportBtn.style.padding = '8px 12px';
            exportBtn.style.fontSize = '0.9rem';
            exportBtn.textContent = '导出数据';
            exportBtn.addEventListener('click', exportData);
            
            const importBtn = document.createElement('button');
            importBtn.className = 'btn btn-nav';
            importBtn.style.padding = '8px 12px';
            importBtn.style.fontSize = '0.9rem';
            importBtn.textContent = '导入数据';
            importBtn.addEventListener('click', showImportDialog);
            
            exportImportContainer.appendChild(exportBtn);
            exportImportContainer.appendChild(importBtn);
            controls.parentNode.insertBefore(exportImportContainer, controls.nextSibling);
            
            const clearAllBtn = document.createElement('button');
            clearAllBtn.className = 'btn btn-delete';
            clearAllBtn.textContent = '清空数据库';
            clearAllBtn.style.marginTop = '10px';
            clearAllBtn.style.width = '100%';
            clearAllBtn.addEventListener('click', () => {
                const confirmDelete = confirm('确定要完全清除所有数据吗？此操作不可撤销！');
                if (confirmDelete) {
                    localStorage.removeItem('teamArchives');
                    alert('所有数据已清除！');
                    resultsSection.style.display = 'none';
                    // 重置界面
                    blueTeam = Array(20).fill(null);
                    redTeam = Array(20).fill(null);
                    updateGrid();
                    updateSelectedList('blue');
                    updateSelectedList('red');
                    updateCount('blue');
                    updateCount('red');
                    checkSaveAvailability();
                }
            });
            
            controls.parentNode.insertBefore(clearAllBtn, exportImportContainer.nextSibling);

            const optimizeBtn = document.createElement('button');
            optimizeBtn.className = 'btn btn-nav';
            optimizeBtn.textContent = '优化数据库';
            optimizeBtn.style.marginTop = '10px';
            optimizeBtn.style.width = '100%';
            optimizeBtn.addEventListener('click', optimizeDatabase);
            controls.parentNode.insertBefore(optimizeBtn, clearAllBtn.nextSibling);
        
        }

        // 新增清空队伍函数
        function clearTeam(team) {
            if (team === 'blue') {
                blueTeam = Array(20).fill(null);
                blueDisplayOrder = [];
            } else {
                redTeam = Array(20).fill(null);
                redDisplayOrder = [];
            }
            updateGrid();
            updateSelectedList(team);
            updateCount(team);
            checkSaveAvailability();
            if (selectedSlot && selectedTeam === team) {
                selectedSlot.classList.remove('selected');
                selectedSlot = null;
                selectedTeam = null;
            }
        }

        function exportData() {
            const savedData = JSON.parse(localStorage.getItem('teamArchives') || '[]');
            if (savedData.length === 0) {
                alert('没有数据可导出！');
                return;
            }
            
            const dataStr = JSON.stringify(savedData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'team_archives.json';
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // 显示导入对话框
        function showImportDialog() {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = '#2c3e50';
            modalContent.style.padding = '25px';
            modalContent.style.borderRadius = '12px';
            modalContent.style.maxWidth = '450px';
            modalContent.style.width = '90%';
            modalContent.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.5)';
            
            // 标题
            const title = document.createElement('h3');
            title.textContent = '导入数据';
            title.style.marginBottom = '20px';
            title.style.color = '#3498db';
            title.style.textAlign = 'center';
            title.style.fontSize = '1.4rem';
            
            // 说明文字
            const description = document.createElement('p');
            description.textContent = '选择导入方式并选择JSON文件：';
            description.style.marginBottom = '15px';
            description.style.color = '#ecf0f1';
            description.style.fontSize = '0.95rem';
            
            // 导入方式按钮
            const importModeContainer = document.createElement('div');
            importModeContainer.style.display = 'flex';
            importModeContainer.style.gap = '12px';
            importModeContainer.style.marginBottom = '20px';
            importModeContainer.style.flexWrap = 'wrap';
            
            const mergeBtn = document.createElement('button');
            mergeBtn.id = 'merge-import';
            mergeBtn.className = 'btn';
            mergeBtn.style.backgroundColor = '#007700';
            mergeBtn.style.color = 'white';
            mergeBtn.style.padding = '10px 15px';
            mergeBtn.style.fontSize = '0.95rem';
            mergeBtn.style.flex = '1';
            mergeBtn.style.minWidth = '120px';
            mergeBtn.textContent = '合并导入';
            
            const overwriteBtn = document.createElement('button');
            overwriteBtn.id = 'overwrite-import';
            overwriteBtn.className = 'btn';
            overwriteBtn.style.backgroundColor = '#ff0000';
            overwriteBtn.style.color = 'white';
            overwriteBtn.style.padding = '10px 15px';
            overwriteBtn.style.fontSize = '0.95rem';
            overwriteBtn.style.flex = '1';
            overwriteBtn.style.minWidth = '120px';
            overwriteBtn.textContent = '覆盖导入';
            
            importModeContainer.appendChild(mergeBtn);
            importModeContainer.appendChild(overwriteBtn);
            
            // 文件输入
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.id = 'import-file';
            fileInput.accept = '.json';
            fileInput.style.width = '100%';
            fileInput.style.padding = '10px';
            fileInput.style.border = '2px dashed #3498db';
            fileInput.style.borderRadius = '8px';
            fileInput.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
            fileInput.style.color = 'white';
            fileInput.style.marginBottom = '20px';
            fileInput.style.fontSize = '1rem';
            
            // 按钮容器
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '12px';
            buttonContainer.style.marginTop = '15px';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.id = 'confirm-import';
            confirmBtn.className = 'btn';
            confirmBtn.style.backgroundColor = '#007700';
            confirmBtn.style.color = 'white';
            confirmBtn.style.padding = '10px 15px';
            confirmBtn.style.flex = '1';
            confirmBtn.textContent = '确认导入';
            confirmBtn.disabled = true;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.id = 'cancel-import';
            cancelBtn.className = 'btn';
            cancelBtn.style.backgroundColor = '#ff0000';
            cancelBtn.style.color = 'white';
            cancelBtn.style.padding = '10px 15px';
            cancelBtn.style.flex = '1';
            cancelBtn.textContent = '取消';
            
            buttonContainer.appendChild(confirmBtn);
            buttonContainer.appendChild(cancelBtn);
            
            // 组装内容
            modalContent.appendChild(title);
            modalContent.appendChild(description);
            modalContent.appendChild(importModeContainer);
            modalContent.appendChild(fileInput);
            modalContent.appendChild(buttonContainer);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 状态变量
            let importMode = null;
            let selectedFile = null;
            
            // 事件监听
            mergeBtn.addEventListener('click', () => {
                importMode = 'merge';
                mergeBtn.style.boxShadow = '0 0 0 3px #9b59b6';
                overwriteBtn.style.boxShadow = 'none';
                updateConfirmButton();
            });
            
            overwriteBtn.addEventListener('click', () => {
                importMode = 'overwrite';
                overwriteBtn.style.boxShadow = '0 0 0 3px #e74c3c';
                mergeBtn.style.boxShadow = 'none';
                updateConfirmButton();
            });
            
            fileInput.addEventListener('change', (e) => {
                selectedFile = e.target.files[0];
                updateConfirmButton();
            });
            
            confirmBtn.addEventListener('click', () => {
                if (!importMode || !selectedFile) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        if (!Array.isArray(importedData)) {
                            throw new Error('无效的数据格式');
                        }
                        
                        // 验证数据格式
                        for (const record of importedData) {
                            if (!record.blueTeam || !record.redTeam || !record.result) {
                                throw new Error('数据格式不正确');
                            }
                        }
                        
                        if (importMode === 'overwrite') {
                            localStorage.setItem('teamArchives', JSON.stringify(importedData));
                            alert(`成功覆盖导入 ${importedData.length} 条记录！`);
                        } else if (importMode === 'merge') {
                            const existingData = JSON.parse(localStorage.getItem('teamArchives') || '[]');
                            const mergedData = [...existingData, ...importedData];
                            localStorage.setItem('teamArchives', JSON.stringify(mergedData));
                            alert(`成功合并导入 ${importedData.length} 条记录！总记录数：${mergedData.length}`);
                        }
                        
                        document.body.removeChild(modal);
                        
                        // 如果当前在查询结果界面，刷新查询
                        if (resultsSection.style.display === 'block') {
                            queryMatches();
                        }
                        
                    } catch (error) {
                        alert('导入失败：' + error.message);
                    }
                };
                
                reader.readAsText(selectedFile);
            });
            
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // 更新确认按钮状态
            function updateConfirmButton() {
                confirmBtn.disabled = !(importMode && selectedFile);
                confirmBtn.style.opacity = confirmBtn.disabled ? '0.6' : '1';
                confirmBtn.style.cursor = confirmBtn.disabled ? 'not-allowed' : 'pointer';
            }
        }
        
        // 启动应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>