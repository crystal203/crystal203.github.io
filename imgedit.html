<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI å›¾åƒç¼–è¾‘ - Gitee AI</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.6;
      background: #f9fafb;
      color: #333;
      padding: 20px;
    }
    header {
      background: #0066cc;
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 24px;
      text-align: center;
    }
    header a {
      color: #ffcc00;
      text-decoration: none;
      font-weight: bold;
    }
    header a:hover {
      text-decoration: underline;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 24px;
      margin-bottom: 20px;
    }
    h2 {
      margin-bottom: 16px;
      color: #1f2937;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
    }
    input, textarea, button {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    #imageInput {
      border: none;
      padding: 0;
    }
    .preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #eee;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    button:hover {
      background: #0052a3;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .log {
      background: #f1f5f9;
      padding: 16px;
      border-radius: 6px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    .status {
      margin-top: 12px;
      padding: 10px;
      border-radius: 6px;
      font-weight: bold;
    }
    .status.pending { background: #fff3cd; color: #856404; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ¨ AI å›¾åƒç¼–è¾‘å™¨</h1>
      <p>è¯·å…ˆåœ¨ <a href="https://ai.gitee.com/" target="_blank">https://ai.gitee.com/</a> æ³¨å†Œè´¦å·å¹¶å…è´¹è·å– API Keyï¼ˆæ¯æ—¥é¢åº¦ 100 å¼ ï¼‰</p>
      <p>æœ¬ç½‘ç«™ä»…åš API çš„å°è£…å’Œè½¬å‘</p>
    </header>

    <div class="card">
      <h2>1ï¸âƒ£ ä¸Šä¼ å›¾ç‰‡ï¼ˆæ”¯æŒå¤šå¼ ï¼‰</h2>
      <input type="file" id="imageInput" multiple accept="image/*" />
      <div class="preview" id="preview"></div>
    </div>

    <div class="card">
      <h2>2ï¸âƒ£ é…ç½®å‚æ•°</h2>
      <label for="apiKey">ğŸ”‘ API Keyï¼ˆå¿…å¡«ï¼‰</label>
      <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥API Key" />

      <label for="prompt">âœï¸ Promptï¼ˆæè¿°ä½ æƒ³ç”Ÿæˆçš„æ•ˆæœï¼‰</label>
      <textarea id="prompt" placeholder="è¯·è¾“å…¥æ–‡æœ¬"></textarea>

      <label>âš™ï¸ ä»»åŠ¡ç±»å‹ï¼ˆè‡ªåŠ¨æ ¹æ®å›¾ç‰‡æ•°é‡åŒ¹é…ï¼‰</label>
      <div id="taskTypesDisplay" style="margin-bottom:16px; padding:10px; background:#f8f9fa; border-radius:4px;"></div>

      <button id="generateBtn">ğŸš€ ä¸€é”®ç”Ÿæˆå›¾åƒ</button>
    </div>

    <div class="card">
      <h2>3ï¸âƒ£ æ—¥å¿— & çŠ¶æ€</h2>
      <div class="log" id="log">ç­‰å¾…æ“ä½œ...</div>
      <div class="status" id="status"></div>
    </div>
  </div>

  <script>
    const imageInput = document.getElementById('imageInput');
    const previewDiv = document.getElementById('preview');
    const apiKeyInput = document.getElementById('apiKey');
    const promptInput = document.getElementById('prompt');
    const generateBtn = document.getElementById('generateBtn');
    const logDiv = document.getElementById('log');
    const statusDiv = document.getElementById('status');
    const taskTypesDisplay = document.getElementById('taskTypesDisplay');

    let selectedFiles = [];

    // é¢„è§ˆå›¾ç‰‡
    imageInput.addEventListener('change', function () {
      previewDiv.innerHTML = '';
      selectedFiles = Array.from(this.files);
      selectedFiles.forEach(file => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result;
          previewDiv.appendChild(img);
        };
        reader.readAsDataURL(file);
      });

      updateTaskTypesDisplay();
    });

    function updateTaskTypesDisplay() {
      const n = selectedFiles.length;
      let types = [];
      if (n === 1) {
        types = ['id']; // å•å›¾ï¼šèº«ä»½ä¿æŒ
      } else if (n >= 2) {
        types = ['id', 'style']; // è‡³å°‘ä¸¤å›¾ï¼šèº«ä»½+é£æ ¼ï¼ˆæ›´å¤šå›¾å¯æ‰©å±•ï¼‰
      }
      taskTypesDisplay.textContent = `å°†ä½¿ç”¨ä»»åŠ¡ç±»å‹ï¼š${types.join(', ')}`;
    }

    // æ—¥å¿—è¾“å‡º
    function log(msg, isError = false) {
      const now = new Date().toLocaleTimeString();
      logDiv.innerHTML += `\n[${now}] ${msg}`;
      logDiv.scrollTop = logDiv.scrollHeight;
      if (isError) {
        statusDiv.className = 'status error';
        statusDiv.textContent = `âŒ é”™è¯¯ï¼š${msg}`;
      }
    }

    function setStatus(msg, type = 'pending') {
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = msg;
    }

    // è½®è¯¢ä»»åŠ¡çŠ¶æ€
    async function pollTask(taskId, headers) {
      const statusUrl = `https://ai.gitee.com/v1/task/${taskId}`;
      const retryInterval = 10 * 1000; // 10ç§’
      const maxAttempts = (30 * 60) / 10; // æœ€å¤š30åˆ†é’Ÿ

      for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        log(`â³ æ­£åœ¨æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ [${attempt}/${maxAttempts}]...`);
        try {
          const response = await fetch(statusUrl, { headers });
          if (!response.ok) throw new Error(`HTTP ${response.status} ${response.statusText}`);
          const result = await response.json();

          if (result.error) {
            throw new Error(`${result.error}: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
          }

          const status = result.status || 'unknown';
          log(`çŠ¶æ€ï¼š${status}`);

          if (status === 'success') {
            if (result.output?.file_url) {
              const url = result.output.file_url;
              log(`âœ… ç”ŸæˆæˆåŠŸï¼å›¾åƒé“¾æ¥ï¼š${url}`);
              setStatus('ğŸ‰ ç”ŸæˆæˆåŠŸï¼å³å°†åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€å›¾åƒâ€¦', 'success');
              window.open(url, '_blank');
              return true;
            } else if (result.output?.text_result) {
              log(`ğŸ“ æ–‡æœ¬ç»“æœï¼š${result.output.text_result}`);
              return true;
            } else {
              log('âš ï¸ æ— è¾“å‡ºå†…å®¹', true);
              return false;
            }
          } else if (['failed', 'cancelled'].includes(status)) {
            log(`âŒ ä»»åŠ¡å¤±è´¥ï¼š${result.message || 'æœªçŸ¥åŸå› '}`, true);
            return false;
          }

          // ç»§ç»­ç­‰å¾…
          await new Promise(resolve => setTimeout(resolve, retryInterval));
        } catch (err) {
          log(`è½®è¯¢å‡ºé”™ï¼š${err.message}`, true);
          return false;
        }
      }

      log('â° ä»»åŠ¡è¶…æ—¶ï¼ˆè¶…è¿‡30åˆ†é’Ÿï¼‰', true);
      return false;
    }

    // ä¸»ç”Ÿæˆé€»è¾‘
    generateBtn.addEventListener('click', async () => {
      const apiKey = apiKeyInput.value.trim();
      const prompt = promptInput.value.trim();

      if (!apiKey) return log('è¯·å¡«å†™ API Key', true);
      if (!prompt) return log('è¯·è¾“å…¥ Prompt', true);
      if (selectedFiles.length === 0) return log('è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ å›¾ç‰‡', true);

      const headers = {
        'Authorization': `Bearer ${apiKey}`
      };

      // æ„å»º FormData
      const formData = new FormData();
      formData.append('prompt', prompt);
      formData.append('model', 'Qwen-Image-Edit-2511');
      formData.append('num_inference_steps', '4');
      formData.append('guidance_scale', '1');

      // æ¨æ–­ task_types
      let taskTypes = [];
      if (selectedFiles.length === 1) {
        taskTypes = ['id'];
      } else if (selectedFiles.length >= 2) {
        taskTypes = ['id', 'style'];
      }
      formData.append('task_types', JSON.stringify(taskTypes));

      // æ·»åŠ å›¾ç‰‡ï¼ˆæŒ‰é¡ºåºï¼‰
      selectedFiles.forEach((file, index) => {
        formData.append('image', file, file.name);
      });

      log('ğŸ“¤ æ­£åœ¨æäº¤ä»»åŠ¡è¯·æ±‚â€¦');
      generateBtn.disabled = true;
      setStatus('ğŸ“¤ æ­£åœ¨æäº¤ä»»åŠ¡â€¦');

      try {
        const response = await fetch('https://ai.gitee.com/v1/async/images/edits', {
          method: 'POST',
          headers: headers,
          body: formData
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`HTTP ${response.status}: ${text}`);
        }

        const data = await response.json();
        if (data.error) throw new Error(`${data.error}: ${data.message || 'Unknown'}`);
        if (!data.task_id) throw new Error('æœªè¿”å› task_id');

        const taskId = data.task_id;
        log(`âœ… ä»»åŠ¡å·²åˆ›å»ºï¼ŒIDï¼š${taskId}`);
        setStatus(`âœ… ä»»åŠ¡å·²æäº¤ï¼ŒIDï¼š${taskId}ï¼Œæ­£åœ¨è½®è¯¢ç»“æœâ€¦`);

        // å¼€å§‹è½®è¯¢
        const success = await pollTask(taskId, headers);
        if (success) {
          setStatus('âœ… å›¾åƒå·²ç”Ÿæˆå¹¶æ‰“å¼€', 'success');
        }
      } catch (err) {
        log(`è¯·æ±‚å¤±è´¥ï¼š${err.message}`, true);
      } finally {
        generateBtn.disabled = false;
      }
    });

    // åˆå§‹åŒ–
    updateTaskTypesDisplay();
  </script>
</body>
</html>