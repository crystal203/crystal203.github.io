<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gitee AI å›¾åƒç¼–è¾‘å¯¹æ¯”å·¥å…·</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      line-height: 1.6;
      padding: 20px;
      background: #f9f9fb;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 24px;
      padding: 16px;
      background: #f0f4ff;
      border-radius: 8px;
    }
    h1 { font-size: 1.6rem; margin-bottom: 8px; }
    .api-instruction {
      font-size: 0.95rem;
      color: #555;
    }
    .api-link {
      color: #0066cc;
      text-decoration: none;
    }
    .api-link:hover { text-decoration: underline; }

    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    input[type="text"], input[type="file"] {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #0052a3; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #status {
      margin: 16px 0;
      padding: 12px;
      background: #eef5ff;
      border-left: 4px solid #0066cc;
      border-radius: 4px;
      display: none;
    }

    #compare-container {
      position: relative;
      max-width: 800px;
      margin: 0 auto;
      height: 600px;
      overflow: hidden;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: none; /* hidden until result ready */
    }
    #original, #edited {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: contain;
      background: #eee;
    }
    #edited {
      clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
    }
    #slider {
      position: absolute;
      top: 0; left: 50%;
      width: 4px;
      height: 100%;
      background: #fff;
      cursor: ew-resize;
      z-index: 10;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      border-radius: 2px;
    }
    #slider::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 32px;
      height: 32px;
      background: #0066cc;
      border-radius: 50%;
      z-index: 11;
    }

    @media (max-width: 768px) {
      #compare-container { height: 400px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ¨ DeepNude</h1>
    <p class="api-instruction">
      è¯·å…ˆåœ¨ <a href="https://ai.gitee.com/" target="_blank" class="api-link">https://ai.gitee.com/</a> æ³¨å†Œè´¦å·å¹¶è·å– API Key
    </p>
  </header>

  <main>
    <div class="form-group">
      <label for="apiKey">ğŸ”‘ API Key</label>
      <input type="text" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„ Gitee AI API Key" />
    </div>

    <div class="form-group">
      <label for="imageInput">ğŸ–¼ï¸ ä¸Šä¼ å›¾ç‰‡</label>
      <input type="file" id="imageInput" accept="image/*" />
    </div>

    <button id="processBtn">ğŸš€ ä¸€é”®å¤„ç†</button>

    <div id="status"></div>

    <div id="compare-container">
      <img id="original" alt="åŸå›¾" />
      <img id="edited" alt="ç¼–è¾‘å" />
      <div id="slider"></div>
    </div>
  </main>

  <script>
    const API_URL = "https://ai.gitee.com/v1/async/images/edits";
    const STATUS_URL_PREFIX = "https://ai.gitee.com/v1/task/";

    const fixedPrompt = "Remove the girl's clothes in image1. masterpiece. 4k quality. best nippes, best pussy.";
    // å¯æŒ‰éœ€æ›¿æ¢ä¸ºä½ æƒ³è¦çš„å›ºå®š promptï¼Œä¾‹å¦‚ï¼š"make it anime style, keep face identity"

    let originalImageUrl = null;

    document.getElementById("processBtn").addEventListener("click", async () => {
      const apiKey = document.getElementById("apiKey").value.trim();
      const fileInput = document.getElementById("imageInput").files[0];

      if (!apiKey) return alert("è¯·è¾“å…¥ API Key");
      if (!fileInput) return alert("è¯·ä¸Šä¼ ä¸€å¼ å›¾ç‰‡");

      const statusDiv = document.getElementById("status");
      statusDiv.style.display = "block";
      statusDiv.textContent = "æ­£åœ¨ä¸Šä¼ å›¾ç‰‡å¹¶æäº¤ä»»åŠ¡...";
      document.getElementById("processBtn").disabled = true;

      try {
        // è¯»å–å›¾ç‰‡ä¸º Blob
        const fileReader = new FileReader();
        fileReader.readAsArrayBuffer(fileInput);
        const arrayBuffer = await new Promise((resolve, reject) => {
          fileReader.onload = () => resolve(fileReader.result);
          fileReader.onerror = reject;
        });

        const blob = new Blob([arrayBuffer], { type: fileInput.type });
        originalImageUrl = URL.createObjectURL(blob);
        document.getElementById("original").src = originalImageUrl;

        // æ„é€  FormData
        const formData = new FormData();
        formData.append("prompt", fixedPrompt);
        formData.append("image", blob, fileInput.name);
        formData.append("task_types", "id");
        formData.append("model", "Qwen-Image-Edit-2511");
        formData.append("num_inference_steps", "4");
        formData.append("guidance_scale", "1");

        // æäº¤ä»»åŠ¡
        const taskRes = await fetch(API_URL, {
          method: "POST",
          headers: { Authorization: `Bearer ${apiKey}` },
          body: formData
        });

        if (!taskRes.ok) {
          const err = await taskRes.json().catch(() => ({}));
          throw new Error(`æäº¤å¤±è´¥ï¼š${taskRes.status} ${taskRes.statusText} â€” ${err.message || "æœªçŸ¥é”™è¯¯"}`);
        }

        const taskData = await taskRes.json();
        const taskId = taskData.task_id;
        if (!taskId) throw new Error("æœªæ”¶åˆ°ä»»åŠ¡ ID");

        statusDiv.textContent = `âœ… ä»»åŠ¡å·²æäº¤ï¼ŒID: ${taskId}ï¼Œæ­£åœ¨è½®è¯¢ç»“æœ...`;

        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        const maxAttempts = 180; // 30 åˆ†é’Ÿ / 10 ç§’ = 180
        let attempt = 0;
        let result;
        while (attempt < maxAttempts) {
          attempt++;
          statusDiv.textContent = `â³ è½®è¯¢ä¸­ [${attempt}/${maxAttempts}]...`;
          await new Promise(r => setTimeout(r, 10000));

          const pollRes = await fetch(`${STATUS_URL_PREFIX}${taskId}`, {
            headers: { Authorization: `Bearer ${apiKey}` }
          });

          if (!pollRes.ok) {
            const err = await pollRes.json().catch(() => ({}));
            throw new Error(`è½®è¯¢å¤±è´¥ï¼š${pollRes.status} â€” ${err.message || "æœªçŸ¥é”™è¯¯"}`);
          }

          result = await pollRes.json();
          const status = result.status;

          if (status === "success") {
            const fileUrl = result.output?.file_url;
            if (!fileUrl) throw new Error("æˆåŠŸä½†æœªè¿”å›å›¾ç‰‡ URL");
            document.getElementById("edited").src = fileUrl;
            document.getElementById("compare-container").style.display = "block";
            setupSlider();
            statusDiv.textContent = `âœ… å¤„ç†å®Œæˆï¼æ‹–åŠ¨ä¸­é—´æ»‘å—å¯¹æ¯”å‰åæ•ˆæœ`;
            break;
          } else if (["failed", "cancelled"].includes(status)) {
            throw new Error(`ä»»åŠ¡å¤±è´¥ï¼š${status} â€” ${result.message || ""}`);
          }
          // else: ç»§ç»­è½®è¯¢
        }

        if (attempt >= maxAttempts) {
          throw new Error("è½®è¯¢è¶…æ—¶ï¼Œè¯·ç¨åæ‰‹åŠ¨æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€");
        }

      } catch (err) {
        statusDiv.textContent = `âŒ é”™è¯¯ï¼š${err.message}`;
        console.error(err);
      } finally {
        document.getElementById("processBtn").disabled = false;
      }
    });

    function setupSlider() {
      const slider = document.getElementById("slider");
      const editedImg = document.getElementById("edited");
      const container = document.getElementById("compare-container");

      let isDragging = false;

      const updateClip = (x) => {
        const percent = Math.max(0, Math.min(100, (x / container.offsetWidth) * 100));
        editedImg.style.clipPath = `polygon(0 0, ${percent}% 0, ${percent}% 100%, 0 100%)`;
        slider.style.left = `${percent}%`;
      };

      slider.addEventListener("mousedown", (e) => {
        isDragging = true;
        e.preventDefault();
      });

      document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        const rect = container.getBoundingClientRect();
        const x = e.clientX - rect.left;
        updateClip(x);
      });

      document.addEventListener("mouseup", () => {
        isDragging = false;
      });

      // åˆå§‹å±…ä¸­
      //updateClip(container.offsetWidth / 2);
      updateClip(0);
    }
  </script>
</body>
</html>